#!/bin/sh

Platform="run.d/platform-box"

pollarg() {
    local Arg=$( basename "$1" )
    PollArg="${PollArg} +${Arg%%.*}%s\\n $1"
}

setdevice() {
    local GPIO=$( readlink "$1" )
    GPIO=${GPIO%/value}
    GPIO=${GPIO#/sys/class/gpio/gpio}
    shift

    local OnlyEcho=echo
    case "${GPIO}" in
    [0-9] | [0-9][0-9] | [0-9][0-9][0-9])
	OnlyEcho=""
	;;
    esac

    $OnlyEcho hwctl export "${GPIO}" "$@"
}

for Arg in ${Platform}/*serial --unique ${Platform}/*.input --debounce 50 ${Platform}/*.switch; do
    case "${Arg}" in
    -* | +* | [0-9]*)
	PollArg="${PollArg} ${Arg}"
	;;
    '*')
	;;
    *.pserial)
	pollarg "${Arg}"
	;;
    *.serial)
	[ -c "${Arg}" ] && {
	    pollarg "${Arg}"
	    stty 9600 raw -echo -echoe -echok -echoctl -echoke  < ${Arg}
	}
	;;
    *.switch)
	pollarg "${Arg}"
	setdevice "${Arg}" in both up
	;;
    *.input)
	pollarg "${Arg}"
	setdevice "${Arg}" in both
	;;
    *.output)
	setdevice "${Arg}" out
	;;
    esac
done

cd ${HOME}/projects/curio/git/box/
poll ${PollArg} | node node_modules/box.js run.d/
